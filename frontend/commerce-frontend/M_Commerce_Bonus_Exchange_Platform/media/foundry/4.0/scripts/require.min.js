FD40.plugin("require",function($){$.require=function(){var getFolderPath=function(path){return $.uri(path).setAnchor("").setQuery("").toPath("../").toString()},self=function(options){var batch=new Batch(options);return self.batches[batch.id]=batch,batch};$.extend(self,{defaultOptions:{path:function(){var path=$.path+"/scripts/"||$("[require-path]").attr("require-path")||getFolderPath($("script:last").attr("src"))||getFolderPath(window.location.href);return/^(\/|\.)/.test(path)&&(path=$.uri(window.location.href).toPath(path).toString()),path
}(),timeout:1e4,retry:3,verbose:"development"==$.environment},setup:function(options){$.extend(self.defaultOptions,options)},batches:{},status:function(filter){return $.each(self.batches,function(i,batch){var count={pending:0,resolved:0,rejected:0,ready:0,total:0},messages=[];$.each(batch.tasks,function(i,task){state=task.module&&"ready"==task.module.status?"ready":task.state(),count[state]++,count.total++,messages.push({state:state,content:"["+state+"] "+task.name})});var batchName=batch.id+": "+batch.state()+" ["+count.resolved+"/"+count.total+"]";
filter&&count[filter]<1||($.IE?(console.log('$.require.batches["'+batch.id+'"]'),$.each(messages,function(i,message){console.log(message.content)}),console.log("")):(console.groupCollapsed(batchName),console.log('$.require.batches["'+batch.id+'"]',batch),$.each(messages,function(i,message){var state=message.state,content=message.content;if(!filter||state==filter)switch(state){case"pending":console.warn(content);break;case"rejected":console.error(content);break;default:console.info(content)}}),console.groupEnd(batchName)))
}),"$.require.status(pending|resolved|rejected|ready);"},loaders:{},addLoader:function(name,factory){self[name]=factory,Batch.prototype[name]=function(){var batch=this;return batch.autoFinalize(),factory.apply(batch,arguments),batch},self.loaders[name]=self[name]=factory},removeLoader:function(name){delete Batch.prototype[name],delete self[name]}});var id=0,Batch=function(options){var required=$.Callbacks("once memory"),isRequired=!1,batch=$.extend(this,{id:++id,tasks:[],options:$.extend({},self.defaultOptions,options),autoFinalizeDuration:300,finalized:!1,required:function(fn){return fn===!0&&(isRequired=!0&&required.fire()),$.isFunction(fn)&&required.add(fn),isRequired
}});return batch};return $.extend(Batch.prototype,{addTask:function(task){var batch=this;$.isDeferred(task)&&(batch.finalized||(batch.tasks.push(task),task.batch=batch))},autoFinalize:function(){var batch=this,duration=batch.autoFinalizeDuration;duration!==!1&&(clearTimeout(batch.autoFinalizeTimer),batch.autoFinalizeTimer=setTimeout(function(){batch.finalize()},duration))},finalize:function(){var batch=this;if(!batch.finalized){batch.finalized=!0;var manager=batch.manager=$.when.apply(null,batch.tasks),promise=manager.promise(),progress=$.Callbacks();
$.extend(batch,promise,{progress:progress.add,notify:progress.fire,done:function(){return batch.required(!0),batch.done=promise.done,batch.done.apply(batch,arguments)}});var verbose=batch.options.verbose;manager.progress(function(state,task){verbose&&"rejected"==state&&console.warn("Require: Task "+task.name+" failed to load.",task)}).fail(function(){verbose&&console.warn("Require: Batch "+batch.id+" failed.",batch)}),setTimeout(function(){$.each(batch.tasks,function(i,task){task.then(function(){batch.notify("resolved",task)
},function(){batch.notify("rejected",task)},function(){batch.notify("progress",task)})})},1)}},expand:function(args,opts){var args=$.makeArray(args),options=opts||{},names=[];return $.isPlainObject(args[0])?(options=$.extend(args[0],opts),names=args.slice(1)):names=args,{options:options,names:names}}}),$.each(["done","fail","progress","always","then"],function(i,method){Batch.prototype[method]=function(){var batch=this;return batch.finalize(),batch[method].apply(batch,arguments)}}),self}(),$.require.addLoader("script",function(){var ajaxHost=$.uri($.indexUrl).host(),documentHost=$.uri(document.location.href).host();
ajaxHost!==documentHost&&ajaxHost.match("xn--")&&($.support.cors=!0);var self=(document.createElement("script").async===!0||"MozAppearance"in document.documentElement.style||window.opera,function(){var options,names,batch=this,args=$.makeArray(arguments);$.isPlainObject(args[0])?(options=args[0],names=args.slice(1)):names=args,options=$.extend({},self.defaultOptions,batch.options,options,{batch:batch});var taskBefore;$.each(names,function(i,name){var task=new self.task(name,options,taskBefore);batch.addTask(task),options.serial&&void 0!==taskBefore?taskBefore.always(task.start):task.start(),taskBefore=task
})});return $.extend(self,{defaultOptions:{path:"",extension:"compressed"==$.mode?"min.js":"js",serial:!1,async:!1,xhr:!1},setup:function(){$.extend(self.defaultOptions,options)},scripts:{},task:function(name,options,taskBefore){var task=$.extend(this,$.Deferred());if(task.name=name,task.options=options,task.taskBefore=taskBefore,$.isArray(name)){task.name=name[0]+"@"+name[1],task.moduleName=name[0];var overrideModuleUrl=name[2];overrideModuleUrl||(task.defineModule=!0,$.module.registry[task.moduleName]&&console.warn("$.require.script: "+task.moduleName+" exists! Using existing module instead."),task.options.xhr=!0),name=name[1],task.module=$.module(task.moduleName)
}$.isUrl(name)?task.url=name:/^(\/|\.)/.test(name)?task.url=$.uri(task.options.path).toPath(name).toString():(task.url=$.uri(task.options.path).toPath("./"+name+"."+task.options.extension).toString(),task.module=$.module(name))}}),$.extend(self.task.prototype,{start:function(){var task=this,module=task.module;return module&&"pending"!==module.status?void task.waitForModule():void task.load()},waitForModule:function(){var task=this,module=task.module;module.then(task.resolve,task.reject,task.notify),task.batch.required(function(){module.done(task.resolve)
})},load:function(){var task=this,taskBefore=task.taskBefore;task.script=self.scripts[task.url]||function(){var script=task.options.xhr?$.ajax({url:task.url,dataType:"text"}):$.script({url:task.url,type:"text/javascript",async:task.options.async,timeout:task.batch.options.timeout,retry:task.batch.options.retry,verbose:task.batch.options.verbose});return self.scripts[task.url]=script}(),task.script.done(function(data){var resolveTask=function(){task.module?task.waitForModule():task.resolve()};return task.options.xhr&&(task.defineModule&&(task.module=$.module(task.moduleName,function(){var module=this;
$.globalEval(data),module.resolveWith(data)})),!task.options.async||taskBefore)?void taskBefore.done(function(){$.globalEval(data),resolveTask()}):void resolveTask()}).fail(function(){task.reject()})}}),self}()),$.require.addLoader("stylesheet",function(){var self=function(){var options,names,batch=this,args=$.makeArray(arguments);$.isPlainObject(args[0])?(options=args[0],names=args.slice(1)):names=args,options=$.extend({},self.defaultOptions,batch.options,{path:$.path+"/styles/"},options,{batch:batch}),$.each(names,function(i,name){var task=new self.task(name,options),existingTask=self.stylesheets[task.url];
task=existingTask||task,batch.addTask(task),existingTask||(self.stylesheets[task.url]=task,task.start())})};return $.extend(self,{defaultOptions:{path:"",extension:"compressed"==$.mode?"min.css":"css",xhr:!1},setup:function(){$.extend(self.defaultOptions,options)},stylesheets:{},task:function(name,options){var task=$.extend(this,$.Deferred());task.name=name,task.options=options,task.url=$.isUrl(name)?name:/^(\/|\.)/.test(name)?$.uri(task.options.path).toPath(name).toString():$.uri(task.options.path).toPath("./"+name+"."+task.options.extension).toString(),task.options.url=task.url
},loaders:{},loader:function(name){if($.isArray(name))return $.map(name,function(name){return self.loader(name)});if($.isPlainObject(name))return $.map(name,function(name,options){return self.loader(name).resolve(options)});var loader=self.loaders[name];return loader||(loader=self.loaders[name]=$.Deferred().done(function(options){$.isPlainObject(options)||$.stylesheet(options)})),loader}}),$.extend(self.task.prototype,{start:function(){var task=this,loader=self.loaders[task.name];loader||(loader=self.loader(task.name),$.stylesheet(task.options)?loader.resolve():loader.reject()),loader.then(task.resolve,task.reject)
}}),self}()),$.require.addLoader("template",function(){var self=function(){var options,names,batch=this,args=$.makeArray(arguments);$.isPlainObject(args[0])?(options=args[0],names=args.slice(1)):names=args,options=$.extend({},self.defaultOptions,batch.options,options,{batch:batch}),$.each(names,function(i,name){var task=new self.task(name,options);batch.addTask(task),task.start()})};return $.extend(self,{defaultOptions:{path:"",extension:"htm"},setup:function(){$.extend(self.defaultOptions,options)},task:function(name,options){var task=$.extend(this,$.Deferred());
task.name=name,task.options=options,$.isArray(name)&&(task.name=name[0],name=name[1]),task.url=$.isUrl(name)?name:/^(\/|\.)/.test(name)?$.uri(task.options.path).toPath(name).toString():$.uri(task.options.path).toPath("./"+name+"."+task.options.extension).toString()},loaders:{},loader:function(name){if($.isArray(name))return $.map(name,function(name){return self.loader(name)});if($.isPlainObject(name))return $.map(name,function(content,name){return self.loader(name).resolve(content)});var loader=self.loaders[name];
return loader||(loader=self.loaders[name]=$.Deferred().done(function(content){$.template(name,content)})),loader}}),$.extend(self.task.prototype,{start:function(){var task=this,loader=self.loaders[task.name];return loader||(loader=self.loader(task.name),loader.xhr=$.Ajax({url:task.url,dataType:"text"}).then(loader.resolve,loader.reject).then(task.resolve,task.reject)),task.loader=loader,task}}),self}()),$.require.addLoader("language",function(){var self=function(){var options,names,batch=this,args=$.makeArray(arguments);
$.isPlainObject(args[0])?(options=args[0],names=args.slice(1)):names=args,options=$.extend({},self.defaultOptions,batch.options,options,{batch:batch});var task=new self.task(names,options);batch.addTask(task),task.start()};return $.extend(self,{defaultOptions:{path:""},setup:function(){$.extend(self.defaultOptions,options)},loaders:{},task:function(names,options){var task=$.extend(this,$.Deferred());task.name=names.join(","),task.options=options,task.url=options.path,task.names=names},loaders:{},loader:function(name){if($.isArray(name))return $.map(name,function(name){return self.loader(name)
});if($.isPlainObject(name))return $.map(name,function(content,name){return self.loader(name).resolve(content)});var loader=self.loaders[name];return loader||(loader=self.loaders[name]=$.Deferred().done(function(string){$.language.add(name,string)})),loader}}),$.extend(self.task.prototype,{start:function(){var task=this,loaders=[],names=$.map(task.names,function(name){var loader=self.loader(name);return loader.push(loader),/resolved|rejected/.test(loader.state())?null:name});return task.fail(function(){$.each(names,function(i,name){self.loader(name).reject()
})}),$.when.apply(null,loaders).then(task.resolve,task.reject),names.length<1?task:(task.xhr=$.Ajax({url:task.url,type:"POST",data:{keys:names}}).done(function(strings){$.isPlainObject(strings)?self.loader(strings):task.reject()}).fail(function(){task.reject()}),task)}}),self}()),$.require.addLoader("library",function(){var names,batch=this,args=$.makeArray(arguments),options={};return $.isPlainObject(args[0])?(options=args[0],names=args.slice(1)):names=args,$.extend(options,{path:$.scriptPath}),batch.script.apply(batch,[options].concat(names))
}),$.require.addLoader("image",function(){var self=function(){var options,names,batch=this,args=$.makeArray(arguments);$.isPlainObject(args[0])?(options=args[0],names=args.slice(1)):names=args,options=$.extend({},self.defaultOptions,batch.options,options,{batch:batch}),$.each(names,function(i,name){var task=new self.task(name,options),existingTask=self.images[task.url];task=existingTask||task,batch.addTask(task),existingTask||(self.images[task.url]=task,task.start())})};return $.extend(self,{defaultOptions:{path:""},setup:function(){$.extend(self.defaultOptions,options)
},images:{},task:function(name,options){var task=$.extend(this,$.Deferred());task.name=name,task.options=options,task.url=$.isUrl(name)?name:/^(\/|\.)/.test(name)?$.uri(task.options.path).toPath(name).toString():$.uri(task.options.path).toPath("./"+name).toString(),task.options.url=task.url}}),$.extend(self.task.prototype,{start:function(){var task=this;task.image=$(new Image).load(function(){task.resolve()}).error(function(){task.reject()}).attr("src",task.options.url)}}),self}())});